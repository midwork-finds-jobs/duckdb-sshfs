# name: test/sql/sshfs/secret_scope.test
# description: Test SSH secret with SCOPE parameter
# group: [sshfs]

require sshfs

require-env SSHFS_TEST_SERVER_AVAILABLE 1

require-env SSHFS_TEST_USERNAME

require-env SSHFS_TEST_PORT

# Override default behaviour of skipping errors
set ignore_error_messages

# Test: Create an SSH secret with SCOPE parameter
statement ok
CREATE SECRET sshfs_scoped_test (
    TYPE SSH,
    USERNAME '${SSHFS_TEST_USERNAME}',
    KEY_PATH 'scripts/test-ssh-key',
    PORT ${SSHFS_TEST_PORT},
    SCOPE 'ssh://localhost'
);

# Verify the secret was created
query I
SELECT count(*) FROM duckdb_secrets() WHERE name = 'sshfs_scoped_test';
----
1

# Test: Use URL that matches the scope
statement ok
CREATE TABLE test_scope AS SELECT 1 as id, 'Scoped' as name, 600 as value;

# This should work - URL matches the scope
statement ok
COPY test_scope TO 'ssh://${SSHFS_TEST_USERNAME}@localhost:${SSHFS_TEST_PORT}/upload/test_scope.csv' (HEADER, DELIMITER ',');

# Cleanup
statement ok
DROP TABLE test_scope;

statement ok
DROP SECRET sshfs_scoped_test;

# Test: Create secret with different scope prefix (sshfs://)
statement ok
CREATE SECRET sshfs_scoped_test2 (
    TYPE SSH,
    USERNAME '${SSHFS_TEST_USERNAME}',
    KEY_PATH 'scripts/test-ssh-key',
    PORT ${SSHFS_TEST_PORT},
    SCOPE 'sshfs://localhost'
);

# Test with sshfs:// prefix
statement ok
CREATE TABLE test_scope2 AS SELECT 2 as id, 'Scoped2' as name, 700 as value;

statement ok
COPY test_scope2 TO 'sshfs://${SSHFS_TEST_USERNAME}@localhost:${SSHFS_TEST_PORT}/upload/test_scope2.csv' (HEADER, DELIMITER ',');

# Cleanup
statement ok
DROP TABLE test_scope2;

statement ok
DROP SECRET sshfs_scoped_test2;
